<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Home Car Rental</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <header>
        <div class="logo-container">
            <span>Home Car Rental - Admin Dashboard</span>
        </div>
        <nav>
            <a href="/admin/dashboard.html">Bookings</a>
            <a href="/admin/pages.html">Pages</a>
            <a href="/admin/reviews.html">Reviews</a>
            <a href="/admin/vendors.html">Vendors</a>
            <a href="/api/admin/logout">Logout</a>
        </nav>
    </header>
    <main>
        <section style="padding: 2rem;">
            <h1>Welcome, Admin!</h1>
            <h2>Bookings</h2>
            <div id="bookings-container">
                <!-- Bookings will be loaded here dynamically -->
            </div>
        </section>
    </main>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const bookingsContainer = document.getElementById('bookings-container');
            const statuses = ['Pending', 'Confirmed', 'Completed', 'Cancelled'];

            function renderBookings(bookings) {
                if (bookings.length === 0) {
                    bookingsContainer.innerHTML = '<p>No bookings found.</p>';
                    return;
                }

                const table = document.createElement('table');
                table.className = 'bookings-table';

                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Mobile</th>
                        <th>Trip Details</th>
                        <th>Date & Time</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                `;
                table.appendChild(thead);

                const tbody = document.createElement('tbody');
                bookings.forEach(booking => {
                    const tr = document.createElement('tr');
                    tr.setAttribute('data-booking-id', booking.id);

                    const statusOptions = statuses.map(s =>
                        `<option value="${s}" ${s === booking.status ? 'selected' : ''}>${s}</option>`
                    ).join('');

                    tr.innerHTML = `
                        <td>${booking.id}</td>
                        <td>${booking.name}<br><small>${booking.email}</small></td>
                        <td>${booking.mobile}</td>
                        <td><b>${booking['trip-type']}</b><br>${booking.pickup} to ${booking.drop}</td>
                        <td>${booking.date} at ${booking.time}</td>
                        <td>
                            <select class="status-select">${statusOptions}</select>
                        </td>
                        <td><button class="update-btn" data-id="${booking.id}">Update</button></td>
                    `;
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);

                bookingsContainer.innerHTML = ''; // Clear previous content
                bookingsContainer.appendChild(table);
            }

            function fetchBookings() {
                fetch('/api/admin/bookings')
                    .then(response => response.ok ? response.json() : Promise.reject('Failed to load'))
                    .then(renderBookings)
                    .catch(error => {
                        console.error('Error fetching bookings:', error);
                        bookingsContainer.innerHTML = '<p>Error loading bookings.</p>';
                    });
            }

            bookingsContainer.addEventListener('click', (event) => {
                if (event.target.classList.contains('update-btn')) {
                    const button = event.target;
                    const bookingId = button.dataset.id;
                    const row = button.closest('tr');
                    const select = row.querySelector('.status-select');
                    const newStatus = select.value;

                    button.textContent = 'Updating...';
                    button.disabled = true;

                    fetch(`/api/admin/bookings/${bookingId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: newStatus }),
                    })
                    .then(response => response.ok ? response.json() : Promise.reject('Update failed'))
                    .then(updatedBooking => {
                        alert(`Booking #${updatedBooking.id} status updated to ${updatedBooking.status}`);
                        // Optionally, visually confirm the change
                        const statusCell = row.querySelector('td:nth-child(6)');
                        statusCell.innerHTML = `<select class="status-select">${statuses.map(s => `<option value="${s}" ${s === updatedBooking.status ? 'selected' : ''}>${s}</option>`).join('')}</select>`;
                    })
                    .catch(error => {
                        console.error('Error updating booking:', error);
                        alert('Failed to update booking.');
                    })
                    .finally(() => {
                        button.textContent = 'Update';
                        button.disabled = false;
                    });
                }
            });

            fetchBookings(); // Initial fetch
        });
    </script>
</body>
</html>
